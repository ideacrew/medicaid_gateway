# frozen_string_literal: true

require "rails_helper"
require 'aca_entities/serializers/xml/medicaid/atp'
require 'aca_entities/atp/transformers/cv/family.rb'

describe Transfers::ToEnroll, "given a soap envelope with an valid xml payload, transfer it to Enroll" do
  let(:body) { StringIO.new(raw_xml) }
  let(:raw_xml) do
    <<-XMLCODE
    <?xml version="1.0" ?><S:Envelope xmlns:S="http://www.w3.org/2003/05/soap-envelope" xmlns:env="http://www.w3.org/2003/05/soap-envelope"><S:Header><wsse:Security xmlns:wsse="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd" xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"><wsu:Timestamp wsu:Id="TS-11"><wsu:Created>2021-07-29T17:56:49Z</wsu:Created><wsu:Expires>2021-07-29T18:21:49Z</wsu:Expires></wsu:Timestamp><wsse:UsernameToken xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd" wsu:Id="UsernameToken-10"><wsse:Username>mesbmqa</wsse:Username><wsse:Password Type="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-username-token-profile-1.0#PasswordDigest">gXotsvC9sWo9o6DCfQy7CYvPR+A=</wsse:Password><wsse:Nonce EncodingType="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-soap-message-security-1.0#Base64Binary">C8Z7TEUavuWC+QW38OaPQg==</wsse:Nonce><wsu:Created>2021-07-29T17:56:49Z</wsu:Created></wsse:UsernameToken></wsse:Security></S:Header><S:Body xmlns:ns1="http://niem.gov/niem/structures/2.0" xmlns:ns10="http://at.dsh.cms.gov/exchange/1.0" xmlns:ns2="http://niem.gov/niem/niem-core/2.0" xmlns:ns3="http://hix.cms.gov/0.1/hix-core" xmlns:ns4="http://hix.cms.gov/0.1/hix-ee" xmlns:ns5="http://at.dsh.cms.gov/extension/1.0" xmlns:ns6="http://niem.gov/niem/domains/screening/2.1" xmlns:ns7="http://hix.cms.gov/0.1/hix-pm" xmlns:ns8="http://niem.gov/niem/appinfo/2.0" xmlns:ns9="http://niem.gov/niem/appinfo/2.1"><ns10:AccountTransferRequest xmlns:ns10="http://at.dsh.cms.gov/exchange/1.0" ns5:atVersionText="2.4"><ns5:TransferHeader><ns5:TransferActivity><ns2:ActivityIdentification><ns2:IdentificationID>IDC61161111111212411</ns2:IdentificationID></ns2:ActivityIdentification><ns2:ActivityDate><ns2:DateTime>2021-07-29T13:56:49.285-04:00</ns2:DateTime></ns2:ActivityDate><ns5:TransferActivityReferralQuantity>1</ns5:TransferActivityReferralQuantity><ns5:RecipientTransferActivityCode>Exchange</ns5:RecipientTransferActivityCode></ns5:TransferActivity></ns5:TransferHeader><ns3:Sender ns1:id="Sender"><ns3:InformationExchangeSystemCategoryCode>MedicaidAgency</ns3:InformationExchangeSystemCategoryCode><ns3:InformationExchangeSystemStateCode>ME</ns3:InformationExchangeSystemStateCode></ns3:Sender><ns3:Receiver ns1:id="Exchange"><ns3:InformationExchangeSystemCategoryCode>Exchange</ns3:InformationExchangeSystemCategoryCode></ns3:Receiver><ns4:InsuranceApplication><ns3:ApplicationCreation><ns2:ActivityDate><ns2:DateTime>2021-04-11T00:00:00.000-04:00</ns2:DateTime></ns2:ActivityDate></ns3:ApplicationCreation><ns3:ApplicationSubmission><ns2:ActivityDate><ns2:DateTime>2021-04-11T00:00:00.000-04:00</ns2:DateTime></ns2:ActivityDate></ns3:ApplicationSubmission><ns3:ApplicationIdentification><ns2:IdentificationID>3927040608</ns2:IdentificationID></ns3:ApplicationIdentification><ns4:InsuranceApplicant><ns3:RoleOfPersonReference ns1:ref="MEPP0000000200987247"></ns3:RoleOfPersonReference><ns4:InsuranceApplicantFixedAddressIndicator>false</ns4:InsuranceApplicantFixedAddressIndicator><ns4:ReferralActivity><ns2:ActivityIdentification><ns2:IdentificationID>IDC61058121961474610</ns2:IdentificationID></ns2:ActivityIdentification><ns2:ActivityDate><ns2:DateTime>2021-05-04T17:06:54.000-04:00</ns2:DateTime></ns2:ActivityDate><ns4:ReferralActivitySenderReference ns1:ref="Sender"></ns4:ReferralActivitySenderReference><ns4:ReferralActivityReceiverReference ns1:ref="Exchange"></ns4:ReferralActivityReceiverReference><ns4:ReferralActivityStatus><ns3:StatusValidDateRange></ns3:StatusValidDateRange><ns4:ReferralActivityStatusCode>Rejected</ns4:ReferralActivityStatusCode></ns4:ReferralActivityStatus></ns4:ReferralActivity></ns4:InsuranceApplicant><ns4:InsuranceApplicationRequestingFinancialAssistanceIndicator>false</ns4:InsuranceApplicationRequestingFinancialAssistanceIndicator><ns4:InsuranceApplicationCoverageRenewalYearQuantity>1</ns4:InsuranceApplicationCoverageRenewalYearQuantity><ns4:SSFSigner><ns3:RoleOfPersonReference ns1:ref="MEPP0000000200987247"></ns3:RoleOfPersonReference><ns4:Signature><ns3:SignatureDate><ns2:Date>2021-04-11-04:00</ns2:Date></ns3:SignatureDate></ns4:Signature><ns4:SSFSignerAuthorizedRepresentativeAssociation><ns4:Signature xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><ns3:SignatureDate xsi:nil="true"></ns3:SignatureDate></ns4:Signature></ns4:SSFSignerAuthorizedRepresentativeAssociation><ns4:SSFAttestation xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><ns4:SSFAttestationCollectionsAgreementIndicator xsi:nil="true"></ns4:SSFAttestationCollectionsAgreementIndicator><ns4:SSFAttestationMedicaidObligationsIndicator xsi:nil="true"></ns4:SSFAttestationMedicaidObligationsIndicator><ns4:SSFAttestationNonPerjuryIndicator>true</ns4:SSFAttestationNonPerjuryIndicator><ns4:SSFAttestationNotIncarceratedIndicator>true</ns4:SSFAttestationNotIncarceratedIndicator><ns4:SSFAttestationInformationChangesIndicator>true</ns4:SSFAttestationInformationChangesIndicator></ns4:SSFAttestation></ns4:SSFSigner><ns4:InsuranceApplicationAssisterAssociation xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><ns2:AssociationBeginDate xsi:nil="true"></ns2:AssociationBeginDate></ns4:InsuranceApplicationAssisterAssociation><ns4:InsuranceApplicationRequestingMedicaidIndicator>false</ns4:InsuranceApplicationRequestingMedicaidIndicator><ns4:SSFPrimaryContact><ns3:RoleOfPersonReference ns1:ref="MEPP0000000200987247"></ns3:RoleOfPersonReference><ns4:SSFPrimaryContactPreferenceCode>Mail</ns4:SSFPrimaryContactPreferenceCode></ns4:SSFPrimaryContact><ns4:InsuranceApplicationTaxReturnAccessIndicator>false</ns4:InsuranceApplicationTaxReturnAccessIndicator></ns4:InsuranceApplication><ns4:MedicaidHousehold ns1:id="MedicaidHousehold"><ns4:HouseholdSizeQuantity>1</ns4:HouseholdSizeQuantity><ns4:HouseholdMemberReference ns1:ref="MEPP0000000200987247"></ns4:HouseholdMemberReference><ns4:MedicaidHouseholdEffectivePersonQuantity>1</ns4:MedicaidHouseholdEffectivePersonQuantity></ns4:MedicaidHousehold><ns3:Person ns1:id="MEPP0000000200987247"><ns2:PersonBirthDate><ns2:Date>2000-01-01-05:00</ns2:Date></ns2:PersonBirthDate><ns2:PersonName><ns2:PersonGivenName>SARAH</ns2:PersonGivenName><ns2:PersonSurName>test</ns2:PersonSurName></ns2:PersonName><ns2:PersonSexText>Female</ns2:PersonSexText><ns2:PersonSSNIdentification><ns2:IdentificationID>123121234</ns2:IdentificationID></ns2:PersonSSNIdentification><ns2:PersonUSCitizenIndicator>true</ns2:PersonUSCitizenIndicator><ns3:TribalAugmentation xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><ns3:PersonAmericanIndianOrAlaskaNativeIndicator>false</ns3:PersonAmericanIndianOrAlaskaNativeIndicator><ns2:LocationStateUSPostalServiceCode xsi:nil="true"></ns2:LocationStateUSPostalServiceCode></ns3:TribalAugmentation><ns3:PersonAugmentation><ns3:PersonContactInformationAssociation><ns2:AssociationBeginDate><ns2:Date>2021-04-11-04:00</ns2:Date></ns2:AssociationBeginDate><ns2:ContactInformationIsPrimaryIndicator>true</ns2:ContactInformationIsPrimaryIndicator><ns3:ContactInformation><ns2:ContactMailingAddress><ns2:StructuredAddress><ns2:LocationStreet><ns2:StreetFullText>Fender Street</ns2:StreetFullText></ns2:LocationStreet><ns2:LocationCityName>Gibsonville</ns2:LocationCityName><ns2:LocationStateUSPostalServiceCode>ME</ns2:LocationStateUSPostalServiceCode><ns2:LocationPostalCode>01234</ns2:LocationPostalCode></ns2:StructuredAddress></ns2:ContactMailingAddress></ns3:ContactInformation><ns3:ContactInformationCategoryCode>Home</ns3:ContactInformationCategoryCode></ns3:PersonContactInformationAssociation><ns3:PersonContactInformationAssociation><ns2:AssociationBeginDate><ns2:Date>2021-04-11-04:00</ns2:Date></ns2:AssociationBeginDate><ns2:ContactInformationIsPrimaryIndicator>false</ns2:ContactInformationIsPrimaryIndicator><ns3:ContactInformation><ns2:ContactMailingAddress><ns2:StructuredAddress><ns2:LocationStreet><ns2:StreetFullText>Fender Street</ns2:StreetFullText></ns2:LocationStreet><ns2:LocationCityName>Gibsonville</ns2:LocationCityName><ns2:LocationStateUSPostalServiceCode>ME</ns2:LocationStateUSPostalServiceCode><ns2:LocationPostalCode>01234</ns2:LocationPostalCode></ns2:StructuredAddress></ns2:ContactMailingAddress></ns3:ContactInformation><ns3:ContactInformationCategoryCode>Mailing</ns3:ContactInformationCategoryCode></ns3:PersonContactInformationAssociation><ns3:PersonContactInformationAssociation><ns2:AssociationBeginDate><ns2:Date>2021-04-11-04:00</ns2:Date></ns2:AssociationBeginDate><ns2:ContactInformationIsPrimaryIndicator>false</ns2:ContactInformationIsPrimaryIndicator><ns3:ContactInformation><ns2:ContactTelephoneNumber><ns2:FullTelephoneNumber><ns2:TelephoneNumberFullID>1231231234</ns2:TelephoneNumberFullID></ns2:FullTelephoneNumber></ns2:ContactTelephoneNumber></ns3:ContactInformation><ns3:ContactInformationCategoryCode>Mobile</ns3:ContactInformationCategoryCode></ns3:PersonContactInformationAssociation><ns3:PersonContactInformationAssociation><ns2:AssociationBeginDate><ns2:Date>2021-04-11-04:00</ns2:Date></ns2:AssociationBeginDate><ns2:ContactInformationIsPrimaryIndicator>false</ns2:ContactInformationIsPrimaryIndicator><ns3:ContactInformation><ns2:ContactEmailID>RockOut@LedZep.com</ns2:ContactEmailID></ns3:ContactInformation><ns3:ContactInformationCategoryCode>Home</ns3:ContactInformationCategoryCode></ns3:PersonContactInformationAssociation><ns3:PersonEmploymentAssociation><ns2:AssociationBeginDate><ns2:Date>2021-01-01-05:00</ns2:Date></ns2:AssociationBeginDate><ns3:Employer ns1:id="MEORG000000209299389"><ns2:OrganizationName>Testing Addresses </ns2:OrganizationName><ns2:OrganizationPrimaryContactInformation><ns2:ContactMailingAddress><ns2:StructuredAddress><ns2:LocationStreet><ns2:StreetFullText>109 Capitol Street</ns2:StreetFullText></ns2:LocationStreet><ns2:LocationCityName>Augusta</ns2:LocationCityName><ns2:LocationStateUSPostalServiceCode>ME</ns2:LocationStateUSPostalServiceCode><ns2:LocationPostalCode>04330</ns2:LocationPostalCode></ns2:StructuredAddress></ns2:ContactMailingAddress></ns2:OrganizationPrimaryContactInformation></ns3:Employer></ns3:PersonEmploymentAssociation><ns3:PersonEmploymentAssociation xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><ns2:AssociationBeginDate xsi:nil="true"></ns2:AssociationBeginDate><ns3:Employer ns1:id="MEORG000000209299390"><ns2:OrganizationName>Testing</ns2:OrganizationName><ns2:OrganizationPrimaryContactInformation><ns2:ContactMailingAddress><ns2:StructuredAddress><ns2:LocationStreet><ns2:StreetFullText>109 Capitol Street</ns2:StreetFullText></ns2:LocationStreet><ns2:AddressSecondaryUnitText>Test 2</ns2:AddressSecondaryUnitText><ns2:LocationCityName>Augusta</ns2:LocationCityName><ns2:LocationStateUSPostalServiceCode>ME</ns2:LocationStateUSPostalServiceCode><ns2:LocationPostalCode>04330</ns2:LocationPostalCode></ns2:StructuredAddress></ns2:ContactMailingAddress></ns2:OrganizationPrimaryContactInformation></ns3:Employer></ns3:PersonEmploymentAssociation><ns3:PersonEmploymentAssociation xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><ns2:AssociationBeginDate xsi:nil="true"></ns2:AssociationBeginDate><ns3:Employer ns1:id="MEORG000000209299391"><ns2:OrganizationName>Fidelity</ns2:OrganizationName><ns2:OrganizationPrimaryContactInformation><ns2:ContactMailingAddress><ns2:StructuredAddress><ns2:LocationStreet><ns2:StreetFullText>109 Capitol Street</ns2:StreetFullText></ns2:LocationStreet><ns2:AddressSecondaryUnitText>Test 2</ns2:AddressSecondaryUnitText><ns2:LocationCityName>Augusta</ns2:LocationCityName><ns2:LocationStateUSPostalServiceCode>ME</ns2:LocationStateUSPostalServiceCode><ns2:LocationPostalCode>04330</ns2:LocationPostalCode></ns2:StructuredAddress></ns2:ContactMailingAddress></ns2:OrganizationPrimaryContactInformation></ns3:Employer></ns3:PersonEmploymentAssociation><ns3:PersonPregnancyStatus><ns3:StatusValidDateRange></ns3:StatusValidDateRange><ns3:StatusIndicator>false</ns3:StatusIndicator><ns3:PregnancyStatusExpectedBabyQuantity>0</ns3:PregnancyStatusExpectedBabyQuantity></ns3:PersonPregnancyStatus><ns3:PersonMedicaidIdentification><ns2:IdentificationID>39035413A</ns2:IdentificationID></ns3:PersonMedicaidIdentification><ns3:PersonIncome xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><ns3:IncomeFrequency><ns3:FrequencyCode>Weekly</ns3:FrequencyCode></ns3:IncomeFrequency><ns3:IncomeAmount>100</ns3:IncomeAmount><ns3:IncomeHoursPerWeekMeasure>5</ns3:IncomeHoursPerWeekMeasure><ns3:IncomeHoursPerPayPeriodMeasure>5</ns3:IncomeHoursPerPayPeriodMeasure><ns3:IncomeDaysPerWeekMeasure>1</ns3:IncomeDaysPerWeekMeasure><ns3:IncomeCategoryCode>Wages</ns3:IncomeCategoryCode><ns3:IncomeDate xsi:nil="true"></ns3:IncomeDate><ns3:IncomeSourceOrganizationReference ns1:ref="MEORG000000209299389"></ns3:IncomeSourceOrganizationReference><ns3:IncomeSubjectToFederalRestrictionsIndicator>false</ns3:IncomeSubjectToFederalRestrictionsIndicator><ns3:IncomePaymentFrequency><ns3:FrequencyCode>Weekly</ns3:FrequencyCode></ns3:IncomePaymentFrequency><ns3:IncomeEarnedDateRange><ns2:StartDate><ns2:Date>2021-01-01-05:00</ns2:Date></ns2:StartDate></ns3:IncomeEarnedDateRange><ns3:IncomeEmploymentDescriptionText>Activities Director  </ns3:IncomeEmploymentDescriptionText><ns3:IncomeUnemploymentSourceText xsi:nil="true"></ns3:IncomeUnemploymentSourceText></ns3:PersonIncome><ns3:PersonIncome xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><ns3:IncomeFrequency><ns3:FrequencyCode>Annually</ns3:FrequencyCode></ns3:IncomeFrequency><ns3:IncomeAmount>100000</ns3:IncomeAmount><ns3:IncomeHoursPerWeekMeasure>100</ns3:IncomeHoursPerWeekMeasure><ns3:IncomeHoursPerPayPeriodMeasure>100</ns3:IncomeHoursPerPayPeriodMeasure><ns3:IncomeDaysPerWeekMeasure>7</ns3:IncomeDaysPerWeekMeasure><ns3:IncomeCategoryCode>SelfEmployment</ns3:IncomeCategoryCode><ns3:IncomeDate xsi:nil="true"></ns3:IncomeDate><ns3:IncomeSourceOrganizationReference ns1:ref="MEORG000000209299390"></ns3:IncomeSourceOrganizationReference><ns3:IncomeSubjectToFederalRestrictionsIndicator>false</ns3:IncomeSubjectToFederalRestrictionsIndicator><ns3:IncomePaymentFrequency><ns3:FrequencyCode>Annually</ns3:FrequencyCode></ns3:IncomePaymentFrequency><ns3:IncomeEarnedDateRange><ns2:StartDate><ns2:Date>2021-01-01-05:00</ns2:Date></ns2:StartDate></ns3:IncomeEarnedDateRange><ns3:IncomeEmploymentDescriptionText>Baker </ns3:IncomeEmploymentDescriptionText><ns3:IncomeUnemploymentSourceText xsi:nil="true"></ns3:IncomeUnemploymentSourceText></ns3:PersonIncome><ns3:PersonIncome xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><ns3:IncomeFrequency><ns3:FrequencyCode>Annually</ns3:FrequencyCode></ns3:IncomeFrequency><ns3:IncomeAmount>1000</ns3:IncomeAmount><ns3:IncomeHoursPerWeekMeasure xsi:nil="true"></ns3:IncomeHoursPerWeekMeasure><ns3:IncomeHoursPerPayPeriodMeasure xsi:nil="true"></ns3:IncomeHoursPerPayPeriodMeasure><ns3:IncomeDaysPerWeekMeasure xsi:nil="true"></ns3:IncomeDaysPerWeekMeasure><ns3:IncomeCategoryCode>CapitalGains</ns3:IncomeCategoryCode><ns3:IncomeDate xsi:nil="true"></ns3:IncomeDate><ns3:IncomeSourceOrganizationReference ns1:ref="MEORG000000209299391"></ns3:IncomeSourceOrganizationReference><ns3:IncomeSubjectToFederalRestrictionsIndicator>false</ns3:IncomeSubjectToFederalRestrictionsIndicator><ns3:IncomePaymentFrequency><ns3:FrequencyCode>Annually</ns3:FrequencyCode></ns3:IncomePaymentFrequency><ns3:IncomeEarnedDateRange><ns2:StartDate><ns2:Date>2021-01-01-05:00</ns2:Date></ns2:StartDate></ns3:IncomeEarnedDateRange><ns3:IncomeEmploymentDescriptionText xsi:nil="true"></ns3:IncomeEmploymentDescriptionText><ns3:IncomeUnemploymentSourceText xsi:nil="true"></ns3:IncomeUnemploymentSourceText></ns3:PersonIncome><ns3:PersonCHIPIdentification><ns2:IdentificationID>39035413A</ns2:IdentificationID></ns3:PersonCHIPIdentification><ns3:PersonMarriedIndicator>false</ns3:PersonMarriedIndicator></ns3:PersonAugmentation></ns3:Person><ns5:PhysicalHousehold><ns4:HouseholdSizeQuantity>1</ns4:HouseholdSizeQuantity><ns4:HouseholdMemberReference ns1:ref="MEPP0000000200987247"></ns4:HouseholdMemberReference></ns5:PhysicalHousehold></ns10:AccountTransferRequest></S:Body></S:Envelope>
    XMLCODE
  end
  let(:document) { Nokogiri::XML(raw_xml) }

  let(:process) { described_class.new }

  let(:processed) { process.call(body) }

  context 'success' do
    context 'with valid application' do
      before do
        @result = process.call(document)
      end

      it 'should return success message' do
        expect(@result).to eq('Transferred account to Enroll')
      end

    end
  end
end